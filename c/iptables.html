
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="description" content="iptables:Linux上常用的防火墙软件 - 最专业的Linux命令大全，内容包含Linux命令手册、详解、学习，值得收藏的Linux命令速查手册。">
    <meta name="keywords" content="Linux,Command,命令大全,Linux命令手册,iptables,Linux上常用的防火墙软件">
    <title>iptables 命令，Linux iptables 命令详解：Linux上常用的防火墙软件 -  Linux 命令搜索引擎</title>
    <link rel="shortcut icon" href="../img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../css/index.css?v=1628823324838">
</head>
<body>

<div class="header header_list">
    <div class="search">
        <ul class="search-list" id="result">
            <!-- <li><a href="#"><strong>find</strong> - 指定目录下查找文件。</a></li> -->
        </ul>
        <input type="text" class="query" id="query" autocomplete="off" autofocus="autofocus" placeholder="Linux 命令搜索"/>
        <div class="enter-input">
            <input type="hidden" id="current_path" value="/c/iptables.html">
            <button id="search_btn">搜索</button>
        </div>
    </div>
</div>

<div class="markdown-body">

<span class="edit_btn">

<span class="split"></span>

</span>

<h1 id="iptables"><a href="#iptables" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>iptables</h1>
<p>Linux上常用的防火墙软件</p>
<h2 id="补充说明"><a href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>补充说明</h2>
<p><strong>iptables命令</strong> 是Linux上常用的防火墙软件，是netfilter项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。</p>
<!-- TOC -->
<ul>
<li><a href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E">补充说明</a>
<ul>
<li><a href="#%E8%AF%AD%E6%B3%95">语法</a></li>
<li><a href="#%E9%80%89%E9%A1%B9">选项</a></li>
</ul>
</li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E5%8F%82%E6%95%B0">基本参数</a>
<ul>
<li><a href="#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9%E8%BE%93%E5%85%A5%E9%A1%BA%E5%BA%8F">命令选项输入顺序</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">工作机制</a></li>
<li><a href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E7%AD%96%E7%95%A5">防火墙的策略</a></li>
<li><a href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E7%AD%96%E7%95%A5-1">防火墙的策略</a></li>
<li><a href="#%E5%AE%9E%E4%BE%8B">实例</a>
<ul>
<li><a href="#%E6%B8%85%E7%A9%BA%E5%BD%93%E5%89%8D%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%84%E5%88%99%E5%92%8C%E8%AE%A1%E6%95%B0">清空当前的所有规则和计数</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8ssh%E7%AB%AF%E5%8F%A3%E8%BF%9E%E6%8E%A5">配置允许ssh端口连接</a></li>
<li><a href="#%E5%85%81%E8%AE%B8%E6%9C%AC%E5%9C%B0%E5%9B%9E%E7%8E%AF%E5%9C%B0%E5%9D%80%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8">允许本地回环地址可以正常使用</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%9A%84%E8%A7%84%E5%88%99">设置默认的规则</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95">配置白名单</a></li>
<li><a href="#%E5%BC%80%E5%90%AF%E7%9B%B8%E5%BA%94%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%A3">开启相应的服务端口</a></li>
<li><a href="#%E4%BF%9D%E5%AD%98%E8%A7%84%E5%88%99%E5%88%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD">保存规则到配置文件中</a></li>
<li><a href="#%E5%88%97%E5%87%BA%E5%B7%B2%E8%AE%BE%E7%BD%AE%E7%9A%84%E8%A7%84%E5%88%99">列出已设置的规则</a></li>
<li><a href="#%E6%B8%85%E9%99%A4%E5%B7%B2%E6%9C%89%E8%A7%84%E5%88%99">清除已有规则</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E5%B7%B2%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%A7%84%E5%88%99">删除已添加的规则</a></li>
<li><a href="#%E5%BC%80%E6%94%BE%E6%8C%87%E5%AE%9A%E7%9A%84%E7%AB%AF%E5%8F%A3">开放指定的端口</a></li>
<li><a href="#%E5%B1%8F%E8%94%BDip">屏蔽IP</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%8C%85%E5%87%BA%E5%8E%BB%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3">指定数据包出去的网络接口</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%A7%84%E5%88%99">查看已添加的规则</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E7%BD%91%E7%BB%9C%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99">启动网络转发规则</a></li>
<li><a href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84">端口映射</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D">字符串匹配</a></li>
<li><a href="#%E9%98%BB%E6%AD%A2windows%E8%A0%95%E8%99%AB%E7%9A%84%E6%94%BB%E5%87%BB">阻止Windows蠕虫的攻击</a></li>
<li><a href="#%E9%98%B2%E6%AD%A2syn%E6%B4%AA%E6%B0%B4%E6%94%BB%E5%87%BB">防止SYN洪水攻击</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h3 id="语法"><a href="#%E8%AF%AD%E6%B3%95" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>语法</h3>
<pre class="language-shell"><code class="language-shell">iptables<span class="token punctuation">(</span>选项<span class="token punctuation">)</span><span class="token punctuation">(</span>参数<span class="token punctuation">)</span>
</code></pre>
<h3 id="选项"><a href="#%E9%80%89%E9%A1%B9" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>选项</h3>
<pre class="language-shell"><code class="language-shell">-t, --table table 对指定的表 table 进行操作， table 必须是 raw， nat，filter，mangle 中的一个。如果不指定此选项，默认的是 filter 表。

<span class="token comment"># 通用匹配：源地址目标地址的匹配</span>
-p：指定要匹配的数据包协议类型；
-s, --source <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> address<span class="token punctuation">[</span>/mask<span class="token punctuation">]</span> ：把指定的一个／一组地址作为源地址，按此规则进行过滤。当后面没有 mask 时，address 是一个地址，比如：192.168.1.1；当 mask 指定时，可以表示一组范围内的地址，比如：192.168.1.0/255.255.255.0。
-d, --destination <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> address<span class="token punctuation">[</span>/mask<span class="token punctuation">]</span> ：地址格式同上，但这里是指定地址为目的地址，按此进行过滤。
-i, --in-interface <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">&#x3C;</span>网络接口name<span class="token operator">></span> ：指定数据包的来自来自网络接口，比如最常见的 eth0 。注意：它只对 INPUT，FORWARD，PREROUTING 这三个链起作用。如果没有指定此选项， 说明可以来自任何一个网络接口。同前面类似，<span class="token string">"!"</span> 表示取反。
-o, --out-interface <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">&#x3C;</span>网络接口name<span class="token operator">></span> ：指定数据包出去的网络接口。只对 OUTPUT，FORWARD，POSTROUTING 三个链起作用。

<span class="token comment"># 查看管理命令</span>
-L, --list <span class="token punctuation">[</span>chain<span class="token punctuation">]</span> 列出链 chain 上面的所有规则，如果没有指定链，列出表上所有链的所有规则。

<span class="token comment"># 规则管理命令</span>
-A, --append chain rule-specification 在指定链 chain 的末尾插入指定的规则，也就是说，这条规则会被放到最后，最后才会被执行。规则是由后面的匹配来指定。
-I, --insert chain <span class="token punctuation">[</span>rulenum<span class="token punctuation">]</span> rule-specification 在链 chain 中的指定位置插入一条或多条规则。如果指定的规则号是1，则在链的头部插入。这也是默认的情况，如果没有指定规则号。
-D, --delete chain rule-specification -D, --delete chain rulenum 在指定的链 chain 中删除一个或多个指定规则。
-R num：Replays替换/修改第几条规则

<span class="token comment"># 链管理命令（这都是立即生效的）</span>
-P, --policy chain target ：为指定的链 chain 设置策略 target。注意，只有内置的链才允许有策略，用户自定义的是不允许的。
-F, --flush <span class="token punctuation">[</span>chain<span class="token punctuation">]</span> 清空指定链 chain 上面的所有规则。如果没有指定链，清空该表上所有链的所有规则。
-N, --new-chain chain 用指定的名字创建一个新的链。
-X, --delete-chain <span class="token punctuation">[</span>chain<span class="token punctuation">]</span> ：删除指定的链，这个链必须没有被其它任何规则引用，而且这条上必须没有任何规则。如果没有指定链名，则会删除该表中所有非内置的链。
-E, --rename-chain old-chain new-chain ：用指定的新名字去重命名指定的链。这并不会对链内部造成任何影响。
-Z, --zero <span class="token punctuation">[</span>chain<span class="token punctuation">]</span> ：把指定链，或者表中的所有链上的所有计数器清零。

-j, --jump target <span class="token operator">&#x3C;</span>指定目标<span class="token operator">></span> ：即满足某条件时该执行什么样的动作。target 可以是内置的目标，比如 ACCEPT，也可以是用户自定义的链。
-h：显示帮助信息；
</code></pre>
<h2 id="基本参数"><a href="#%E5%9F%BA%E6%9C%AC%E5%8F%82%E6%95%B0" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>基本参数</h2>
<p>| 参数 | 作用 |
| ---- | ---- |
| -P |  设置默认策略:iptables -P INPUT (DROP|ACCEPT) |
| -F |  清空规则链 |
| -L |  查看规则链 |
| -A |  在规则链的末尾加入新规则 |
| -I | num  在规则链的头部加入新规则 |
| -D | num  删除某一条规则 |
| -s |  匹配来源地址IP/MASK，加叹号"!"表示除这个IP外。 |
| -d |  匹配目标地址 |
| -i | 网卡名称 匹配从这块网卡流入的数据 |
| -o | 网卡名称 匹配从这块网卡流出的数据 |
| -p |  匹配协议,如tcp,udp,icmp |
| --dport num | 匹配目标端口号 |
| --sport num | 匹配来源端口号 |</p>
<h4 id="命令选项输入顺序"><a href="#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9%E8%BE%93%E5%85%A5%E9%A1%BA%E5%BA%8F" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>命令选项输入顺序</h4>
<pre class="language-shell"><code class="language-shell">iptables -t 表名 <span class="token operator">&#x3C;</span>-A/I/D/R<span class="token operator">></span> 规则链名 <span class="token punctuation">[</span>规则号<span class="token punctuation">]</span> <span class="token operator">&#x3C;</span>-i/o 网卡名<span class="token operator">></span> -p 协议名 <span class="token operator">&#x3C;</span>-s 源IP/源子网<span class="token operator">></span> --sport 源端口 <span class="token operator">&#x3C;</span>-d 目标IP/目标子网<span class="token operator">></span> --dport 目标端口 -j 动作
</code></pre>
<h4 id="工作机制"><a href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>工作机制</h4>
<p>规则链名包括(也被称为五个钩子函数（hook functions）)：</p>
<ul>
<li><strong>INPUT链</strong> ：处理输入数据包。</li>
<li><strong>OUTPUT链</strong> ：处理输出数据包。</li>
<li><strong>FORWARD链</strong> ：处理转发数据包。</li>
<li><strong>PREROUTING链</strong> ：用于目标地址转换（DNAT）。</li>
<li><strong>POSTOUTING链</strong> ：用于源地址转换（SNAT）。</li>
</ul>
<h4 id="防火墙的策略"><a href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E7%AD%96%E7%95%A5" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>防火墙的策略</h4>
<p>防火墙策略一般分为两种，一种叫<code>通</code>策略，一种叫<code>堵</code>策略，通策略，默认门是关着的，必须要定义谁能进。堵策略则是，大门是洞开的，但是你必须有身份认证，否则不能进。所以我们要定义，让进来的进来，让出去的出去，<code>所以通，是要全通，而堵，则是要选择</code>。当我们定义的策略的时候，要分别定义多条功能，其中：定义数据包中允许或者不允许的策略，filter过滤的功能，而定义地址转换的功能的则是nat选项。为了让这些功能交替工作，我们制定出了“表”这个定义，来定义、区分各种不同的工作功能和处理方式。</p>
<p>我们现在用的比较多个功能有3个：</p>
<ol>
<li>filter 定义允许或者不允许的，只能做在3个链上：INPUT ，FORWARD ，OUTPUT</li>
<li>nat 定义地址转换的，也只能做在3个链上：PREROUTING ，OUTPUT ，POSTROUTING</li>
<li>mangle功能:修改报文原数据，是5个链都可以做：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</li>
</ol>
<p>我们修改报文原数据就是来修改TTL的。能够实现将数据包的元数据拆开，在里面做标记/修改内容的。而防火墙标记，其实就是靠mangle来实现的。</p>
<p>小扩展:</p>
<ul>
<li>对于filter来讲一般只能做在3个链上：INPUT ，FORWARD ，OUTPUT</li>
<li>对于nat来讲一般也只能做在3个链上：PREROUTING ，OUTPUT ，POSTROUTING</li>
<li>而mangle则是5个链都可以做：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</li>
</ul>
<p>iptables/netfilter（这款软件）是工作在用户空间的，它可以让规则进行生效的，本身不是一种服务，而且规则是立即生效的。而我们iptables现在被做成了一个服务，可以进行启动，停止的。启动，则将规则直接生效，停止，则将规则撤销。</p>
<p>iptables还支持自己定义链。但是自己定义的链，必须是跟某种特定的链关联起来的。在一个关卡设定，指定当有数据的时候专门去找某个特定的链来处理，当那个链处理完之后，再返回。接着在特定的链中继续检查。</p>
<p>注意：规则的次序非常关键，<code>谁的规则越严格，应该放的越靠前</code>，而检查规则的时候，是按照从上往下的方式进行检查的。</p>
<p>表名包括：</p>
<ul>
<li><strong>raw</strong> ：高级功能，如：网址过滤。</li>
<li><strong>mangle</strong> ：数据包修改（QOS），用于实现服务质量。</li>
<li><strong>nat</strong> ：地址转换，用于网关路由器。</li>
<li><strong>filter</strong> ：包过滤，用于防火墙规则。</li>
</ul>
<p>动作包括：</p>
<ul>
<li><strong>ACCEPT</strong> ：接收数据包。</li>
<li><strong>DROP</strong> ：丢弃数据包。</li>
<li><strong>REDIRECT</strong> ：重定向、映射、透明代理。</li>
<li><strong>SNAT</strong> ：源地址转换。</li>
<li><strong>DNAT</strong> ：目标地址转换。</li>
<li><strong>MASQUERADE</strong> ：IP伪装（NAT），用于ADSL。</li>
<li><strong>LOG</strong> ：日志记录。</li>
<li><strong>SEMARK</strong> : 添加SEMARK标记以供网域内强制访问控制（MAC）</li>
</ul>
<pre class="language-shell"><code class="language-shell">                             ┏╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍┓
 ┌───────────────┐           ┃    Network    ┃
 │ table: filter │           ┗━━━━━━━┳━━━━━━━┛
 │ chain: INPUT  │◀────┐             │
 └───────┬───────┘     │             ▼
         │             │   ┌───────────────────┐
  ┌      ▼      ┐      │   │ table: nat        │
  │local process│      │   │ chain: PREROUTING │
  └             ┘      │   └─────────┬─────────┘
         │             │             │
         ▼             │             ▼              ┌─────────────────┐
┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅    │     ┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅      │table: nat       │
 Routing decision      └───── outing decision ─────▶│chain: PREROUTING│
┅┅┅┅┅┅┅┅┅┳┅┅┅┅┅┅┅┅┅          ┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅      └────────┬────────┘
         │                                                   │
         ▼                                                   │
 ┌───────────────┐                                           │
 │ table: nat    │           ┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅┅               │
 │ chain: OUTPUT │    ┌─────▶ outing decision ◀──────────────┘
 └───────┬───────┘    │      ┅┅┅┅┅┅┅┅┳┅┅┅┅┅┅┅┅
         │            │              │
         ▼            │              ▼
 ┌───────────────┐    │   ┌────────────────────┐
 │ table: filter │    │   │ chain: POSTROUTING │
 │ chain: OUTPUT ├────┘   └──────────┬─────────┘
 └───────────────┘                   │
                                     ▼
                             ┏╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍┓
                             ┃    Network    ┃
                             ┗━━━━━━━━━━━━━━━┛
</code></pre>
<h3 id="实例"><a href="#%E5%AE%9E%E4%BE%8B" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>实例</h3>
<h4 id="清空当前的所有规则和计数"><a href="#%E6%B8%85%E7%A9%BA%E5%BD%93%E5%89%8D%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%84%E5%88%99%E5%92%8C%E8%AE%A1%E6%95%B0" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>清空当前的所有规则和计数</h4>
<pre class="language-shell"><code class="language-shell">iptables -F  <span class="token comment"># 清空所有的防火墙规则</span>
iptables -X  <span class="token comment"># 删除用户自定义的空链</span>
iptables -Z  <span class="token comment"># 清空计数</span>
</code></pre>
<h4 id="配置允许ssh端口连接"><a href="#%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8ssh%E7%AB%AF%E5%8F%A3%E8%BF%9E%E6%8E%A5" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>配置允许ssh端口连接</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -s <span class="token number">192.168</span>.1.0/24 -p tcp --dport <span class="token number">22</span> -j ACCEPT
<span class="token comment"># 22为你的ssh端口， -s 192.168.1.0/24表示允许这个网段的机器来连接，其它网段的ip地址是登陆不了你的机器的。 -j ACCEPT表示接受这样的请求</span>
</code></pre>
<h4 id="允许本地回环地址可以正常使用"><a href="#%E5%85%81%E8%AE%B8%E6%9C%AC%E5%9C%B0%E5%9B%9E%E7%8E%AF%E5%9C%B0%E5%9D%80%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>允许本地回环地址可以正常使用</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -i lo -j ACCEPT
<span class="token comment">#本地圆环地址就是那个127.0.0.1，是本机上使用的,它进与出都设置为允许</span>
iptables -A OUTPUT -o lo -j ACCEPT
</code></pre>
<h4 id="设置默认的规则"><a href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%9A%84%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>设置默认的规则</h4>
<pre class="language-shell"><code class="language-shell">iptables -P INPUT DROP <span class="token comment"># 配置默认的不让进</span>
iptables -P FORWARD DROP <span class="token comment"># 默认的不允许转发</span>
iptables -P OUTPUT ACCEPT <span class="token comment"># 默认的可以出去</span>
</code></pre>
<h4 id="配置白名单"><a href="#%E9%85%8D%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>配置白名单</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -p all -s <span class="token number">192.168</span>.1.0/24 -j ACCEPT  <span class="token comment"># 允许机房内网机器可以访问</span>
iptables -A INPUT -p all -s <span class="token number">192.168</span>.140.0/24 -j ACCEPT  <span class="token comment"># 允许机房内网机器可以访问</span>
iptables -A INPUT -p tcp -s <span class="token number">183.121</span>.3.7 --dport <span class="token number">3380</span> -j ACCEPT <span class="token comment"># 允许183.121.3.7访问本机的3380端口</span>
</code></pre>
<h4 id="开启相应的服务端口"><a href="#%E5%BC%80%E5%90%AF%E7%9B%B8%E5%BA%94%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%A3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>开启相应的服务端口</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT <span class="token comment"># 开启80端口，因为web对外都是这个端口</span>
iptables -A INPUT -p icmp --icmp-type <span class="token number">8</span> -j ACCEPT <span class="token comment"># 允许被ping</span>
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span class="token comment"># 已经建立的连接得让它进来</span>
</code></pre>
<h4 id="保存规则到配置文件中"><a href="#%E4%BF%9D%E5%AD%98%E8%A7%84%E5%88%99%E5%88%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>保存规则到配置文件中</h4>
<pre class="language-shell"><code class="language-shell"><span class="token function">cp</span> /etc/sysconfig/iptables /etc/sysconfig/iptables.bak <span class="token comment"># 任何改动之前先备份，请保持这一优秀的习惯</span>
iptables-save <span class="token operator">></span> /etc/sysconfig/iptables
<span class="token function">cat</span> /etc/sysconfig/iptables
</code></pre>
<h4 id="列出已设置的规则"><a href="#%E5%88%97%E5%87%BA%E5%B7%B2%E8%AE%BE%E7%BD%AE%E7%9A%84%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>列出已设置的规则</h4>
<blockquote>
<p>iptables -L [-t 表名] [链名]</p>
</blockquote>
<ul>
<li>四个表名 <code>raw</code>，<code>nat</code>，<code>filter</code>，<code>mangle</code></li>
<li>五个规则链名 <code>INPUT</code>、<code>OUTPUT</code>、<code>FORWARD</code>、<code>PREROUTING</code>、<code>POSTROUTING</code></li>
<li>filter表包含<code>INPUT</code>、<code>OUTPUT</code>、<code>FORWARD</code>三个规则链</li>
</ul>
<pre class="language-shell"><code class="language-shell">iptables -L -t nat                  <span class="token comment"># 列出 nat 上面的所有规则</span>
<span class="token comment">#            ^ -t 参数指定，必须是 raw， nat，filter，mangle 中的一个</span>
iptables -L -t nat  --line-numbers  <span class="token comment"># 规则带编号</span>
iptables -L INPUT

iptables -L -nv  <span class="token comment"># 查看，这个列表看起来更详细</span>
</code></pre>
<h4 id="清除已有规则"><a href="#%E6%B8%85%E9%99%A4%E5%B7%B2%E6%9C%89%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>清除已有规则</h4>
<pre class="language-shell"><code class="language-shell">iptables -F INPUT  <span class="token comment"># 清空指定链 INPUT 上面的所有规则</span>
iptables -X INPUT  <span class="token comment"># 删除指定的链，这个链必须没有被其它任何规则引用，而且这条上必须没有任何规则。</span>
                   <span class="token comment"># 如果没有指定链名，则会删除该表中所有非内置的链。</span>
iptables -Z INPUT  <span class="token comment"># 把指定链，或者表中的所有链上的所有计数器清零。</span>
</code></pre>
<h4 id="删除已添加的规则"><a href="#%E5%88%A0%E9%99%A4%E5%B7%B2%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>删除已添加的规则</h4>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># 添加一条规则</span>
iptables -A INPUT -s <span class="token number">192.168</span>.1.5 -j DROP
</code></pre>
<p>将所有iptables以序号标记显示，执行：</p>
<pre class="language-shell"><code class="language-shell">iptables -L -n --line-numbers
</code></pre>
<p>比如要删除INPUT里序号为8的规则，执行：</p>
<pre class="language-shell"><code class="language-shell">iptables -D INPUT <span class="token number">8</span>
</code></pre>
<h4 id="开放指定的端口"><a href="#%E5%BC%80%E6%94%BE%E6%8C%87%E5%AE%9A%E7%9A%84%E7%AB%AF%E5%8F%A3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>开放指定的端口</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -s <span class="token number">127.0</span>.0.1 -d <span class="token number">127.0</span>.0.1 -j ACCEPT               <span class="token comment">#允许本地回环接口(即运行本机访问本机)</span>
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    <span class="token comment">#允许已建立的或相关连的通行</span>
iptables -A OUTPUT -j ACCEPT         <span class="token comment">#允许所有本机向外的访问</span>
iptables -A INPUT -p tcp --dport <span class="token number">22</span> -j ACCEPT    <span class="token comment">#允许访问22端口</span>
iptables -A INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT    <span class="token comment">#允许访问80端口</span>
iptables -A INPUT -p tcp --dport <span class="token number">21</span> -j ACCEPT    <span class="token comment">#允许ftp服务的21端口</span>
iptables -A INPUT -p tcp --dport <span class="token number">20</span> -j ACCEPT    <span class="token comment">#允许FTP服务的20端口</span>
iptables -A INPUT -j reject       <span class="token comment">#禁止其他未允许的规则访问</span>
iptables -A FORWARD -j REJECT     <span class="token comment">#禁止其他未允许的规则访问</span>
</code></pre>
<h4 id="屏蔽ip"><a href="#%E5%B1%8F%E8%94%BDip" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>屏蔽IP</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -p tcp -m tcp -s <span class="token number">192.168</span>.0.8 -j DROP  <span class="token comment"># 屏蔽恶意主机（比如，192.168.0.8</span>
iptables -I INPUT -s <span class="token number">123.45</span>.6.7 -j DROP       <span class="token comment">#屏蔽单个IP的命令</span>
iptables -I INPUT -s <span class="token number">123.0</span>.0.0/8 -j DROP      <span class="token comment">#封整个段即从123.0.0.1到123.255.255.254的命令</span>
iptables -I INPUT -s <span class="token number">124.45</span>.0.0/16 -j DROP    <span class="token comment">#封IP段即从123.45.0.1到123.45.255.254的命令</span>
iptables -I INPUT -s <span class="token number">123.45</span>.6.0/24 -j DROP    <span class="token comment">#封IP段即从123.45.6.1到123.45.6.254的命令是</span>
</code></pre>
<h4 id="指定数据包出去的网络接口"><a href="#%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%8C%85%E5%87%BA%E5%8E%BB%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>指定数据包出去的网络接口</h4>
<p>只对 OUTPUT，FORWARD，POSTROUTING 三个链起作用。</p>
<pre class="language-shell"><code class="language-shell">iptables -A FORWARD -o eth0
</code></pre>
<h4 id="查看已添加的规则"><a href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>查看已添加的规则</h4>
<pre class="language-shell"><code class="language-shell">iptables -L -n -v
Chain INPUT <span class="token punctuation">(</span>policy DROP <span class="token number">48106</span> packets, 2690K bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
 <span class="token number">5075</span>  589K ACCEPT     all  --  lo     *       <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0
 191K   90M ACCEPT     tcp  --  *      *       <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0           tcp dpt:22
1499K  133M ACCEPT     tcp  --  *      *       <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0           tcp dpt:80
4364K 6351M ACCEPT     all  --  *      *       <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0           state RELATED,ESTABLISHED
 <span class="token number">6256</span>  327K ACCEPT     icmp --  *      *       <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0

Chain FORWARD <span class="token punctuation">(</span>policy ACCEPT <span class="token number">0</span> packets, <span class="token number">0</span> bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination

Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 3382K packets, 1819M bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token builtin class-name">source</span>               destination
 <span class="token number">5075</span>  589K ACCEPT     all  --  *      lo      <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0
</code></pre>
<h4 id="启动网络转发规则"><a href="#%E5%90%AF%E5%8A%A8%E7%BD%91%E7%BB%9C%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>启动网络转发规则</h4>
<p>公网<code>210.14.67.7</code>让内网<code>192.168.188.0/24</code>上网</p>
<pre class="language-shell"><code class="language-shell">iptables -t nat -A POSTROUTING -s <span class="token number">192.168</span>.188.0/24 -j SNAT --to-source <span class="token number">210.14</span>.67.127
</code></pre>
<h4 id="端口映射"><a href="#%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>端口映射</h4>
<p>本机的 2222 端口映射到内网 虚拟机的22 端口</p>
<pre class="language-shell"><code class="language-shell">iptables -t nat -A PREROUTING -d <span class="token number">210.14</span>.67.127 -p tcp --dport <span class="token number">2222</span>  -j DNAT --to-dest <span class="token number">192.168</span>.188.115:22
</code></pre>
<h4 id="字符串匹配"><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>字符串匹配</h4>
<p>比如，我们要过滤所有TCP连接中的字符串<code>test</code>，一旦出现它我们就终止这个连接，我们可以这么做：</p>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -p tcp -m string --algo kmp --string <span class="token string">"test"</span> -j REJECT --reject-with tcp-reset
iptables -L

<span class="token comment"># Chain INPUT (policy ACCEPT)</span>
<span class="token comment"># target     prot opt source               destination</span>
<span class="token comment"># REJECT     tcp  --  anywhere             anywhere            STRING match "test" ALGO name kmp TO 65535 reject-with tcp-reset</span>
<span class="token comment">#</span>
<span class="token comment"># Chain FORWARD (policy ACCEPT)</span>
<span class="token comment"># target     prot opt source               destination</span>
<span class="token comment">#</span>
<span class="token comment"># Chain OUTPUT (policy ACCEPT)</span>
<span class="token comment"># target     prot opt source               destination</span>
</code></pre>
<h4 id="阻止windows蠕虫的攻击"><a href="#%E9%98%BB%E6%AD%A2windows%E8%A0%95%E8%99%AB%E7%9A%84%E6%94%BB%E5%87%BB" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>阻止Windows蠕虫的攻击</h4>
<pre class="language-shell"><code class="language-shell">iptables -I INPUT -j DROP -p tcp -s <span class="token number">0.0</span>.0.0/0 -m string --algo kmp --string <span class="token string">"cmd.exe"</span>
</code></pre>
<h4 id="防止syn洪水攻击"><a href="#%E9%98%B2%E6%AD%A2syn%E6%B4%AA%E6%B0%B4%E6%94%BB%E5%87%BB" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>防止SYN洪水攻击</h4>
<pre class="language-shell"><code class="language-shell">iptables -A INPUT -p tcp --syn -m limit --limit <span class="token number">5</span>/second -j ACCEPT
</code></pre>
<h4 id="添加secmark记录"><a href="#%E6%B7%BB%E5%8A%A0secmark%E8%AE%B0%E5%BD%95" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>添加SECMARK记录</h4>
<pre class="language-shell"><code class="language-shell">iptables -t mangle -A INPUT -p tcp --src <span class="token number">192.168</span>.1.2 --dport <span class="token number">443</span> -j SECMARK --selctx system_u:object_r:myauth_packet_t
<span class="token comment"># 向从 192.168.1.2:443 以TCP方式发出到本机的包添加MAC安全上下文 system_u:object_r:myauth_packet_t</span>
</code></pre>
<h2 id="更多实例"><a href="#%E6%9B%B4%E5%A4%9A%E5%AE%9E%E4%BE%8B" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>更多实例</h2>
<blockquote>
<p>用iptables搭建一套强大的安全防护盾 http://www.imooc.com/learn/389</p>
</blockquote>
<p>iptables: linux 下应用层防火墙工具</p>
<p>iptables 5链: 对应 Hook point
netfilter: linux 操作系统核心层内部的一个数据包处理模块
Hook point: 数据包在 netfilter 中的挂载点; <code>PRE_ROUTING / INPUT / OUTPUT / FORWARD / POST_ROUTING</code></p>
<p>iptables &#x26; netfilter
<img src="http://7xq89b.com1.z0.glb.clouddn.com/netfilter&#x26;iptables.jpg" alt=""></p>
<p>iptables 4表5链
<img src="http://7xq89b.com1.z0.glb.clouddn.com/iptables-data-stream.jpg" alt=""></p>
<p>iptables rules
<img src="http://7xq89b.com1.z0.glb.clouddn.com/iptables-rules.jpg" alt=""></p>
<ul>
<li>4表</li>
</ul>
<p><strong>filter</strong>: 访问控制 / 规则匹配
<strong>nat</strong>: 地址转发
mangle / raw</p>
<ul>
<li>规则</li>
</ul>
<p>数据访问控制: ACCEPT / DROP / REJECT
数据包改写(nat -> 地址转换): snat / dnat
信息记录: log</p>
<h2 id="使用场景实例"><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%AE%9E%E4%BE%8B" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>使用场景实例</h2>
<ul>
<li>场景一</li>
</ul>
<p>开放 tcp 10-22/80 端口
开放 icmp
其他未被允许的端口禁止访问</p>
<p>存在的问题: 本机无法访问本机; 本机无法访问其他主机</p>
<ul>
<li>场景二</li>
</ul>
<p>ftp: 默认被动模式(服务器产生随机端口告诉客户端, 客户端主动连接这个端口拉取数据)
vsftpd: 使 ftp 支持主动模式(客户端产生随机端口通知服务器, 服务器主动连接这个端口发送数据)</p>
<ul>
<li>场景三</li>
</ul>
<p>允许外网访问:
web
http -> 80/tcp; https -> 443/tcp
mail
smtp -> 25/tcp; smtps -> 465/tcp
pop3 -> 110/tcp; pop3s -> 995/tcp
imap -> 143/tcp</p>
<p>内部使用:
file
nfs -> 123/udp
samba -> 137/138/139/445/tcp
ftp -> 20/21/tcp
remote
ssh -> 22/tcp
sql
mysql -> 3306/tcp
oracle -> 1521/tcp</p>
<ul>
<li>场景四</li>
</ul>
<p>nat 转发</p>
<ul>
<li>场景五</li>
</ul>
<p>防CC攻击</p>
<pre class="language-shell"><code class="language-shell">iptables -L -F -A -D <span class="token comment"># list flush append delete</span>
<span class="token comment"># 场景一</span>
iptables -I INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT <span class="token comment"># 允许 tcp 80 端口</span>
iptables -I INPUT -p tcp --dport <span class="token number">10</span>:22 -j ACCEPT <span class="token comment"># 允许 tcp 10-22 端口</span>
iptables -I INPUT -p icmp -j ACCEPT <span class="token comment"># 允许 icmp</span>
iptables -A INPUT -j REJECT <span class="token comment"># 添加一条规则, 不允许所有</span>

<span class="token comment"># 优化场景一</span>
iptables -I INPUT -i lo -j ACCEPT <span class="token comment"># 允许本机访问</span>
iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span class="token comment"># 允许访问外网</span>
iptables -I INPUT -p tcp --dport <span class="token number">80</span> -s <span class="token number">10.10</span>.188.233 -j ACCEPT <span class="token comment"># 只允许固定ip访问80</span>

<span class="token comment"># 场景二</span>
<span class="token function">vi</span> /etc/vsftpd/vsftpd.conf <span class="token comment"># 使用 vsftpd 开启 ftp 主动模式</span>
<span class="token assign-left variable">port_enable</span><span class="token operator">=</span>yes
<span class="token assign-left variable">connect_from_port_20</span><span class="token operator">=</span>YES
iptables -I INPUT -p tcp --dport <span class="token number">21</span> -j ACCEPT

<span class="token function">vi</span> /etc/vsftpd/vsftpd.conf <span class="token comment"># 建议使用 ftp 被动模式</span>
<span class="token assign-left variable">pasv_min_port</span><span class="token operator">=</span><span class="token number">50000</span>
<span class="token assign-left variable">pasv_max_port</span><span class="token operator">=</span><span class="token number">60000</span>
iptables -I INPUT -p tcp --dport <span class="token number">21</span> -j ACCEPT
iptables -I INPUT -p tcp --dport <span class="token number">50000</span>:60000 -j ACCEPT

<span class="token comment"># 还可以使用 iptables 模块追踪来自动开发对应的端口</span>

<span class="token comment"># 场景三</span>
iptables -I INPUT -i lo -j ACCEPT <span class="token comment"># 允许本机访问</span>
iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT <span class="token comment"># 允许访问外网</span>
iptables -I INPUT -s <span class="token number">10.10</span>.155.0/24 -j ACCEPT <span class="token comment"># 允许内网访问</span>
iptables -I INPUT -p tcp -m multiport --dports <span class="token number">80,1723</span> -j ACCEPT <span class="token comment"># 允许端口, 80 -> http, 1723 -> vpn</span>
iptables -A INPUT -j REJECT <span class="token comment"># 添加一条规则, 不允许所有</span>

iptables-save <span class="token comment"># 保存设置到配置文件</span>

<span class="token comment"># 场景四</span>
iptables -t nat -L <span class="token comment"># 查看 nat 配置</span>

iptables -t nat -A POST_ROUTING -s <span class="token number">10.10</span>.177.0/24 -j SNAT --to <span class="token number">10.10</span>.188.232 <span class="token comment"># SNAT</span>
<span class="token function">vi</span> /etc/sysconfig/network <span class="token comment"># 配置网关</span>

iptables -t nat -A POST_ROUTING -d <span class="token number">10.10</span>.188.232 -p tcp --dport <span class="token number">80</span> -j DNAT --to <span class="token number">10.10</span>.177.232:80 <span class="token comment"># DNAT</span>

<span class="token comment">#场景五</span>
iptables -I INPUT -p tcp --syn --dport <span class="token number">80</span> -m connlimit --connlimit-above <span class="token number">100</span> -j REJECT <span class="token comment"># 限制并发连接访问数</span>
iptables -I INPUT -m limit --limit <span class="token number">3</span>/hour --limit-burst <span class="token number">10</span> -j ACCEPT <span class="token comment"># limit模块; --limit-burst 默认为5</span>
</code></pre>
<!-- Linux命令行搜索引擎：https://jaywcjlove.github.io/linux-command/ -->
</div>

<div class="footer  footer_index "><a href="../hot.html">Linux 命令列表</a></div><script type="text/javascript" src="../js/dt.js?v=1628823324531"></script><script type="text/javascript" src="../js/index.js?v=1628823324531"></script></body></html>