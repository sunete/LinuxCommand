
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="description" content="script:记录终端会话的所有操作 - 最专业的Linux命令大全，内容包含Linux命令手册、详解、学习，值得收藏的Linux命令速查手册。">
    <meta name="keywords" content="Linux,Command,命令大全,Linux命令手册,script,记录终端会话的所有操作">
    <title>script 命令，Linux script 命令详解：记录终端会话的所有操作 -  Linux 命令搜索引擎</title>
    <link rel="shortcut icon" href="../img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../css/index.css?v=1628823325026">
</head>
<body>

<div class="header header_list">
    <div class="search">
        <ul class="search-list" id="result">
            <!-- <li><a href="#"><strong>find</strong> - 指定目录下查找文件。</a></li> -->
        </ul>
        <input type="text" class="query" id="query" autocomplete="off" autofocus="autofocus" placeholder="Linux 命令搜索"/>
        <div class="enter-input">
            <input type="hidden" id="current_path" value="/c/script.html">
            <button id="search_btn">搜索</button>
        </div>
    </div>
</div>

<div class="markdown-body">

<span class="edit_btn">

<span class="split"></span>

</span>

<h1 id="script"><a href="#script" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>script</h1>
<p>记录终端会话的所有操作</p>
<h2 id="补充说明"><a href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>补充说明</h2>
<p><strong>script</strong> 用于在终端会话中，记录用户的所有操作和命令的输出信息。简而言之，记录终端会话发生的一切信息，如同一台终端录像机。例如，用户在输入某条命令时，字符的键入和删除也都会被记录。用户在终端的所有操作、终端的回显等信息会被以 <code>raw</code> 格式存储在日志文件，称为终端数据文件。命令的时间信息会被单独以另一种结构储存为日志文件，称为时间日志文件。使用命令<code>exit</code>或者快捷键<code>Ctrl + D</code>停止记录。</p>
<h3 id="语法"><a href="#%E8%AF%AD%E6%B3%95" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>语法</h3>
<pre class="language-shell"><code class="language-shell">script<span class="token punctuation">(</span>选项<span class="token punctuation">)</span><span class="token punctuation">(</span>参数<span class="token punctuation">)</span>
</code></pre>
<h3 id="选项"><a href="#%E9%80%89%E9%A1%B9" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>选项</h3>
<pre class="language-shell"><code class="language-shell">-a, --append              <span class="token comment"># 对终端会话的操作信息，以追加方式写入文件（保留原文件内容）</span>
-c, --command <span class="token builtin class-name">command</span>     <span class="token comment"># 只运行 command 命令而不打开交互终端。相当于开启 script ，执行 command ，再退出 script</span>
                          <span class="token comment"># command 可以是任意能够在终端会话执行的命令</span>
-e, --return              <span class="token comment"># 返回子进程的退出状态码</span>
-f, --flush               <span class="token comment"># 每次终端的内容发生变动，立马写入日志文件</span>
--force                   <span class="token comment"># 允许默认输出终端数据文件为符号链接</span>
-o, --output-limit size   <span class="token comment"># 限制终端数据文件和时间日志文件的大小，当文件大小达到此限制就会退出子进程</span>
                          <span class="token comment"># size 的单位可以设置为：KiB(=1024)、KB(=1000)、MiB(1024*1024)、MB(=1000*1000)</span>
                          <span class="token comment"># 同理还支持 GiB TiB PiB EiB ZiB YiB GB TB PB EB ZB YB</span>
-q, --quiet               <span class="token comment"># 安静模式。启动和退出script命令不显示任何提示</span>
-t<span class="token punctuation">[</span>file<span class="token punctuation">]</span>, --timing<span class="token punctuation">[</span><span class="token operator">=</span>file<span class="token punctuation">]</span> <span class="token comment"># 输出时间日志信息到标准错误(stderr)或者文件</span>
-V, --version             <span class="token comment"># 显示版本信息并退出</span>
-h, --help                <span class="token comment"># 显示帮助文本并退出</span>
</code></pre>
<h3 id="参数"><a href="#%E5%8F%82%E6%95%B0" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>参数</h3>
<ul>
<li>终端数据文件：设置存储终端数据信息的文件名称</li>
</ul>
<h3 id="实例"><a href="#%E5%AE%9E%E4%BE%8B" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>实例</h3>
<pre class="language-shell"><code class="language-shell">script                             <span class="token comment"># 开启记录，默认会在当前目录创建名称为 typescript 的文件来保存终端数据文件</span>
script command.log                 <span class="token comment"># 开启记录，在当前目录创建名称为 command.log 的文件来保存终端数据文件</span>
script -t <span class="token operator"><span class="token file-descriptor important">2</span>></span>time.file command.log  <span class="token comment"># 开启记录，在当前目录创建名称为 command.log 的文件来保存终端数据文件</span>
                                   <span class="token comment"># 在当前目录创建名称为 time.file 的文件来保存时间日志文件</span>
</code></pre>
<p><strong>以追加模式记录终端信息</strong></p>
<pre class="language-shell"><code class="language-shell">zfb@localhost:~$ script -t <span class="token operator"><span class="token file-descriptor important">2</span>></span>time.file -a -f command.log
Script started, <span class="token function">file</span> is command.log
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token string">"hello, world"</span>
hello, world
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>
<span class="token number">2020</span>-12-23 <span class="token number">20</span>:48:46
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token string">"Bye"</span>
Bye
zfb@localhost:~$ <span class="token function">ls</span> -al
total <span class="token number">20</span>
drwxr-xr-x  <span class="token number">2</span> zfb zfb <span class="token number">4096</span> Dec <span class="token number">23</span> <span class="token number">20</span>:48 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">37</span> zfb zfb <span class="token number">4096</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 <span class="token punctuation">..</span>
-rw-r--r--  <span class="token number">1</span> zfb zfb    <span class="token number">0</span> Dec <span class="token number">23</span> <span class="token number">19</span>:03 a.txt
-rw-r--r--  <span class="token number">1</span> zfb zfb   <span class="token number">12</span> Dec <span class="token number">23</span> <span class="token number">19</span>:04 b.txt
-rw-r--r--  <span class="token number">1</span> zfb zfb <span class="token number">2744</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 command.log
-rw-r--r--  <span class="token number">1</span> zfb zfb  <span class="token number">790</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 time.file
zfb@localhost:~$ <span class="token builtin class-name">exit</span>
Script done, <span class="token function">file</span> is command.log
zfb@localhost:~$
</code></pre>
<p>然后，用户可以查看终端数据文件，使用方法如下</p>
<pre class="language-shell"><code class="language-shell">zfb@localhost:~$ <span class="token function">cat</span> command.log
Script started on <span class="token number">2020</span>-12-23 <span class="token number">20</span>:48:25+08:00 <span class="token punctuation">[</span><span class="token environment constant">TERM</span><span class="token operator">=</span><span class="token string">"xterm-256color"</span> <span class="token assign-left variable">TTY</span><span class="token operator">=</span><span class="token string">"/dev/pts/0"</span> <span class="token assign-left variable"><span class="token environment constant">COLUMNS</span></span><span class="token operator">=</span><span class="token string">"75"</span> <span class="token assign-left variable"><span class="token environment constant">LINES</span></span><span class="token operator">=</span><span class="token string">"30"</span><span class="token punctuation">]</span>
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token string">"hello, world"</span>
hello, world
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>
<span class="token number">2020</span>-12-23 <span class="token number">20</span>:48:46
zfb@localhost:~$ <span class="token builtin class-name">echo</span> <span class="token string">"Bye"</span>
Bye
zfb@localhost:~$ <span class="token function">ls</span> -al
total <span class="token number">20</span>
drwxr-xr-x  <span class="token number">2</span> zfb zfb <span class="token number">4096</span> Dec <span class="token number">23</span> <span class="token number">20</span>:48 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">37</span> zfb zfb <span class="token number">4096</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 <span class="token punctuation">..</span>
-rw-r--r--  <span class="token number">1</span> zfb zfb    <span class="token number">0</span> Dec <span class="token number">23</span> <span class="token number">19</span>:03 a.txt
-rw-r--r--  <span class="token number">1</span> zfb zfb   <span class="token number">12</span> Dec <span class="token number">23</span> <span class="token number">19</span>:04 b.txt
-rw-r--r--  <span class="token number">1</span> zfb zfb <span class="token number">2744</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 command.log
-rw-r--r--  <span class="token number">1</span> zfb zfb  <span class="token number">790</span> Dec <span class="token number">23</span> <span class="token number">20</span>:49 time.file
zfb@localhost:~$ <span class="token builtin class-name">exit</span>

Script <span class="token keyword">done</span> on <span class="token number">2020</span>-12-23 <span class="token number">20</span>:49:04+08:00 <span class="token punctuation">[</span>COMMAND_EXIT_CODE<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">]</span>
zfb@localhost:~$
</code></pre>
<p>其中，只有命令<code>cat command.log</code>是用户输入，其他均为自动呈现。通过查看上面输出的时间<code>2020-12-23 20:48:46</code>，可以证明，这是重现的记录，而非重新执行一遍命令。也就是说，可以把<code>time.file</code>和<code>command.log</code>文件移动到任意一台机器上，都可以重现命令输入与终端回显。</p>
<p><strong>记录服务器用户会话操作</strong></p>
<p>以<code>root</code>身份编辑文件<code>/etc/profile</code>，在文件末尾追加以下内容</p>
<pre class="language-bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token environment constant">$UID</span> -ge <span class="token number">0</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token builtin class-name">exec</span> /usr/bin/script -t <span class="token operator"><span class="token file-descriptor important">2</span>></span>/var/log/script-records/<span class="token environment constant">$USER</span>-<span class="token environment constant">$UID</span>-<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d<span class="token variable">`</span></span>.time -a -f -q /var/log/script-records/<span class="token environment constant">$USER</span>-<span class="token environment constant">$UID</span>-<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d<span class="token variable">`</span></span>.log
<span class="token keyword">fi</span>
</code></pre>
<p>然后再以<code>root</code>身份创建文件夹用于存储服务器上的各个用户在终端的所有操作信息</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /var/log/script-records/
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">733</span> /var/log/script-records/
</code></pre>
<p>最后，执行命令<code>source /etc/profile</code>即可。任意用户（<code>UID ≥ 0</code>）在终端执行的所有操作都会被安静地记录下来，以天为单位存储。</p>
<!-- Linux命令行搜索引擎：https://jaywcjlove.github.io/linux-command/ -->
</div>

<div class="footer  footer_index "><a href="../hot.html">Linux 命令列表</a></div><script type="text/javascript" src="../js/dt.js?v=1628823324531"></script><script type="text/javascript" src="../js/index.js?v=1628823324531"></script></body></html>